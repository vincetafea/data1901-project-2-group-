---
title: "Merge df"
author: "DL"
date: "24/03/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Main Processing
```{r}
library(tidyverse)
library(dplyr)
library(readxl)
library(readr)
library(stringr)
library(fuzzyjoin)
library(ggplot2)
library(scales)

###########################
### Code for setting up 'merged' df from the other sheets
#TODO fix EN translations

# Negates the first 2 spaces and then reads everything after
###en <- read_csv("Arch_english_inscriptions.txt")
###en$english_translations <- str_match(en$`!/R Engelsk översättning`, regex("(?: [^ ]* [^ ]* )(.*)"))

# Starts from the beginning of each line and reads all chars that aren't a space, then reads the space. Repeats 3 times, essentially matching the first 3 words
###en$name <- str_match(en$`!/R Engelsk översättning`, regex("(?:^(\\S+\\s+){3})"))

master_data <- read_excel("Arch_master_spreadsheet-2.xls")

crosses_data <- read_excel("Arch_crosses_spreadsheet.xlsx")

merged <- left_join(master_data, crosses_data)

#TODO
# Attempting to merg translations
#translations <- en %>%
#  select(name, english_translations)   
#merged <- fuzzy_join(merged, en, by = c("Signum" = "name"), match_fun = str_detect)
###########################



###########################
### Renames existing columns and summarises the crosses columns

# Renames columns
merged <-
merged %>%
 rename(
    Signature = Signum,
    Found_Location = Plats,
    Parish = Socken,
    District = Härad,
    Municipality = Kommun,
    Coordinates = Koordinater,
    Style_Grouping = Stilgruppering,
    Carver = Ristare,
    Material_Type = Materialtyp,
    Picture_Link = Bildlänk,
    Cross_Num = '#'
  )

# Summarises totals for cross types
merged$Total_A <- merged$A1 + merged$A2 + merged$A3 + merged$A4 + merged$A5 + merged$A6 + merged$A7 + merged$A8 + merged$A9
merged$Total_B <- merged$B1 + merged$B2 + merged$B3 + merged$B4
merged$Total_C <- merged$C1 + merged$C2 + merged$C3 + merged$C4 + merged$C5 + merged$C6 + merged$C7 + merged$C8 + merged$C9 + merged$C10

### TODO GOTTA ADD D


merged$Total_E <- merged$E1 + merged$E2 + merged$E3 + merged$E4 + merged$E5 + merged$E6 + merged$E7 + merged$E8 + merged$E9 + merged$E10
merged$Total_F <- merged$F1 + merged$F2 + merged$F3 + merged$F4
merged$Total_G <- merged$G1 + merged$G2 + merged$G3 + merged$G4 + merged$G5 + merged$G6
###########################



###########################
### Code for carver data cleaning and Signed runestones


# Filters out entries with no carver data
merged <- filter(merged, !(merged$Carver == ('')))

# Finds all entries in 'Carver' with '(A)'
merged$Attributed <- str_match(merged$Carver, ".*\\(A\\)")

# Finds all entries in 'Carver' with '(S)'
merged$Signed <- str_match(merged$Carver, ".*\\(S\\)")

# Regex for matching up to and including the first (S) only, filtering out most collabs


########TODO doing the below screws up the df -- try use grepl or an alternative method ........>############NOTE
#merged$Signed <- str_match(merged$Signed, regex("^(.*?)\\(S\\)"))

# Removes all NA data entries by the column Signed
merged <- merged[complete.cases(merged$Signed), ]
###########################



###########################
### Code for cleaning coordinates and lat/long cols

# Filters out entries with no coordinate data
merged <- filter(merged, 
!(merged$Coordinates == ('')))

# read the right of the coordinates: (\d+.)$
merged$lat <- str_match(merged$Coordinates, regex("\\d+$"))

# read the left of the coordinates: ^[^.]*
merged$long <- str_match(merged$Coordinates, regex("^\\d+"))

# Filters out all NA and blank coord
merged <- filter(merged, 
!(merged$lat == ('')))

merged$lat <- as.numeric(merged$lat)
merged$long <- as.numeric(merged$long)
###########################



###########################
### Code for ordering and extracting data about carvers and num of runestones

# Adds a column containing the frequency of each occurance in signed called s_freq
merged <- transform(merged, s_freq=ave(seq(nrow(merged)),Signed,FUN=length))

#Sorts the table in descending order by s_freq
merged <- arrange(merged, desc(s_freq))

#Creates a temporary df with distinct values of Signed it's corresponding s_freq
disc_signed_df <- distinct(merged, Signed, s_freq)

#Extracts the top 5 unique carvers
unique_sig <- disc_signed_df$Signed
unique_sig <- unique_sig[1:5]

#Extracts their corresponding number of runestones
unique_freq <- disc_signed_df$s_freq
unique_freq <- unique_freq[1:5]
###########################



#merged[is.element(merged$Signed, unique_sig)]


top_5_df <- merged[merged$Signed %in% unique_sig, ]
view(top_5_df)
```




## Lat/long 

```{r}
#TODO fix scales
#TODO consider lat or long on which axis
scatter1 <- ggplot(top_5_df, aes(x = long, y = lat, colour = Signed)) + 
  geom_point() +
  scale_x_continuous(name = "Longitude") +
  scale_y_continuous(name = "Latitude")
scatter1
```

```{r}
#TODO fix scales
#TODO consider lat or long on which axis
scatter1 <- ggplot(top_5_df, aes(x = long, y = lat, colour = Signed)) + 
  stat_density_2d()
scatter1
```

```{r}
#TODO fix scales
#TODO consider lat or long on which axis
scatter1 <- ggplot(top_5_df, aes(x = long, y = lat, colour = Signed)) + 
  geom_bin_2d()
scatter1
```



## Time period + frequency 
Style grouping legened
RAK	990-1010 AD   
FP	1010-1050 AD
Pr1	1010-1040 AD
Pr2	1020-1050 AD
Pr3	1050 – 1070 AD
Pr4	1060-1100 AD
Pr5	1100-1130 AD
```{r}
bar1 <- ggplot(top_5_df, aes(x = reorder(Signed, -s_freq), fill = Style_Grouping)) + 
                     geom_bar()

#TODO add legend for time period of styles
#TODO add a label for the total quanitity of each carver

bar1
```



## Crosses
```{r}
########################

## ACTUAL IDEA
# y-axis == subspace of total crosses completely ignore runestones of that specific carver
# Filled by each style in a stacked bar chart sort of things

########################

# Main idea: proportion of each cross style (total c(A:G)) that each carver used
# x-axis = carver, y-axis = proportion of cross styles as a % of runestones carved

## Ideas
# Seperate by carver -- find the styles of each carver
  # Create 5 charts -- 1 for each carver
  # Determine the style that each carver used -- draw interesting conclusion (qualitative)

## Steps
# Create new temp df for filtered by each carver
# Bar chart is coloured by crosses

###########################

opir_df <- filter(merged, Signed == "Öpir 1 (S)")

# Creates a column containing the total entries of A
opir_df$A_TF <- opir_df$Total_A > 0

#
A_trues <- sum(opir_df$A_TF == TRUE, na.rm = T)

view(opir_df)


###########################

#view(opir_df)
#opir_plot <- ggplot(opir_df, aes(x = Signed)) +
#  geom_bar()
#opir_plot

```


# Misc
```{r}

# How to assign variables with a for loop
for (i in c("A", "B", "C", "D", "E"))
{
  assign(paste("var", i, sep=""), i) #replace the last i with what you want each var to be
}

```

